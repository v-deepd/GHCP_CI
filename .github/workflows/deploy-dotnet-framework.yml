name: Deploy .NET Framework App to Azure

on:
  push:
    branches: [ main ]
    paths:
      - 'Use-cases/02-NetFramework30-ASPNET-WEB/**'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_WEBAPP_NAME: webapp-apps-winmig-emea-v-deepd-demo-web
  AZURE_WEBAPP_PACKAGE_PATH: 'Use-cases/02-NetFramework30-ASPNET-WEB'
  AZURE_CLIENT_ID: 'd27a4c73-d0da-4636-b677-f08138df4733'
  AZURE_TENANT_ID: '0e478cd4-3e52-496d-ac3a-419ca58ba7ac'
  AZURE_SUBSCRIPTION_ID: '95642268-5116-484d-9b88-7dfce8c20ce4'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      
    - name: Restore NuGet packages
      run: nuget restore "${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/NetFramework30ASPNETWEB.sln"
      
    - name: Build and publish
      run: |
        Write-Host "Building project..."
        msbuild "${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/NetFramework30ASPNETWEB.csproj" `
          /p:Configuration=Release `
          /p:Platform=AnyCPU `
          /p:DeployOnBuild=true `
          /p:PublishProfile=FolderProfile `
          /verbosity:minimal
          
        Write-Host "`nCopying files from PackageTmp to publish folder..."
        $packageTmp = "${{ env.AZURE_WEBAPP_PACKAGE_PATH }}\obj\Release\Package\PackageTmp"
        $publishFolder = "${{ github.workspace }}\publish"
        
        if (Test-Path $packageTmp) {
          New-Item -ItemType Directory -Force -Path $publishFolder | Out-Null
          Copy-Item "$packageTmp\*" -Destination $publishFolder -Recurse -Force
          
          $files = Get-ChildItem $publishFolder -Recurse -File
          Write-Host "Successfully copied $($files.Count) files to publish folder"
          Write-Host "`nSample files:"
          $files | Select-Object -First 10 | ForEach-Object { Write-Host "  $($_.FullName.Replace($publishFolder, ''))" }
        } else {
          Write-Host "ERROR: PackageTmp folder not found at $packageTmp"
          exit 1
        }
      
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: webapp
        path: '${{ github.workspace }}\publish'

  deploy:
    runs-on: windows-latest
    needs: build
    environment:
      name: 'Production'
      url: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: webapp
        path: webapp
        
    - name: Azure CLI Login
      run: |
        Write-Host "Logging in to Azure using service principal..."
        Write-Host "Client ID: ${{ env.AZURE_CLIENT_ID }}"
        Write-Host "Tenant ID: ${{ env.AZURE_TENANT_ID }}"
        Write-Host "Subscription ID: ${{ env.AZURE_SUBSCRIPTION_ID }}"
        
        $clientSecret = '${{ fromJSON(secrets.AZURE_CREDENTIALS).clientSecret }}'
        Write-Host "Client Secret length: $($clientSecret.Length)"
        
        az login --service-principal --username ${{ env.AZURE_CLIENT_ID }} --password $clientSecret --tenant ${{ env.AZURE_TENANT_ID }}
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Azure login failed with exit code $LASTEXITCODE"
          exit 1
        }
        
        Write-Host "`nLogin successful! Setting subscription..."
        az account set --subscription ${{ env.AZURE_SUBSCRIPTION_ID }}
        
        Write-Host "`nCurrent account:"
        az account show
        
    - name: Verify Azure Login
      run: |
        Write-Host "Verifying Azure account..."
        $account = az account show 2>&1
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Azure account show failed"
          Write-Host $account
          exit 1
        }
        Write-Host $account
        Write-Host "`nChecking web app..."
        az webapp show --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group rg-infra-winmig-eme-v-deepd-demo --query "{name:name,state:state}" -o json
        
    - name: Create deployment package
      run: |
        Compress-Archive -Path webapp\* -DestinationPath deploy.zip -Force
        
    - name: Deploy to Azure Web App
      run: |
        az webapp deployment source config-zip --resource-group rg-infra-winmig-eme-v-deepd-demo --name ${{ env.AZURE_WEBAPP_NAME }} --src deploy.zip
        
    - name: Logout from Azure
      run: |
        $account = az account show 2>&1
        if ($LASTEXITCODE -eq 0) {
          Write-Host "Logging out..."
          az logout
        } else {
          Write-Host "No active account to logout from"
        }
      if: always()