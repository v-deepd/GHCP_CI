name: Deploy .NET Framework App to Azure

on:
  push:
    branches: [ main ]
    paths:
      - 'Use-cases/02-NetFramework30-ASPNET-WEB/**'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_WEBAPP_NAME: webapp-apps-winmig-emea-v-deepd-demo-web
  AZURE_WEBAPP_PACKAGE_PATH: 'Use-cases/02-NetFramework30-ASPNET-WEB'
  AZURE_CLIENT_ID: 'd27a4c73-d0da-4636-b677-f08138df4733'
  AZURE_TENANT_ID: '0e478cd4-3e52-496d-ac3a-419ca58ba7ac'
  AZURE_SUBSCRIPTION_ID: '95642268-5116-484d-9b88-7dfce8c20ce4'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      
    - name: Restore NuGet packages
      run: nuget restore "${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/NetFramework30ASPNETWEB.sln"
      
    - name: Build and publish
      run: |
        msbuild "${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/NetFramework30ASPNETWEB.csproj" `
          /p:Configuration=Release `
          /p:Platform=AnyCPU `
          /p:DeployOnBuild=true `
          /p:WebPublishMethod=FileSystem `
          /p:publishUrl="${{ github.workspace }}\publish" `
          /p:DeleteExistingFiles=True
      
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: webapp
        path: '${{ github.workspace }}\publish'

  deploy:
    runs-on: windows-latest
    needs: build
    permissions:
      id-token: write
      contents: read
    environment:
      name: 'Production'
      url: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: webapp
        path: webapp
        
    - name: Azure Login via OIDC
      uses: azure/login@v1
      with:
        client-id: ${{ env.AZURE_CLIENT_ID }}
        tenant-id: ${{ env.AZURE_TENANT_ID }}
        subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
      continue-on-error: false
        
    - name: Debug - Check environment and login
      run: |
        Write-Host "=== Environment Variables ==="
        Write-Host "Client ID: ${{ env.AZURE_CLIENT_ID }}"
        Write-Host "Tenant ID: ${{ env.AZURE_TENANT_ID }}"
        Write-Host "Subscription ID: ${{ env.AZURE_SUBSCRIPTION_ID }}"
        Write-Host "`n=== Azure CLI Version ==="
        az --version
        Write-Host "`n=== Attempting to show account ==="
        try {
          az account show
          Write-Host "✓ Account show succeeded"
        } catch {
          Write-Host "✗ Account show failed: $_"
          Write-Host "`n=== Attempting manual token login ==="
          $idToken = $env:ACTIONS_ID_TOKEN_REQUEST_TOKEN
          Write-Host "ID Token Request Token present: $($null -ne $idToken)"
        }
        Write-Host "`n=== Setting subscription explicitly ==="
        az account set --subscription ${{ env.AZURE_SUBSCRIPTION_ID }}
        Write-Host "`n=== Verifying account after set ==="
        az account show
        Write-Host "`n=== Checking webapp access ==="
        az webapp show --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group rg-infra-winmig-eme-v-deepd-demo --query "{name:name,state:state,hostNames:hostNames}" -o json
        
    - name: Create deployment package
      run: |
        Compress-Archive -Path webapp\* -DestinationPath deploy.zip -Force
        
    - name: Deploy to Azure Web App
      run: |
        az webapp deployment source config-zip --resource-group rg-infra-winmig-eme-v-deepd-demo --name ${{ env.AZURE_WEBAPP_NAME }} --src deploy.zip
        
    - name: Logout from Azure
      run: az logout
      if: always()